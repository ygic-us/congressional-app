/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/plugin/Plugin","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/api/ExtensionPointRegistryAPI"],function(P,D,F,M,E){"use strict";var A=P.extend("sap.ui.rta.plugin.AddXMLAtExtensionPoint",{metadata:{library:"sap.ui.rta",properties:{fragmentHandler:{type:"function"}},associations:{},events:{}}});var a="addXMLAtExtensionPoint";var b="appdescr_ui5_setFlexExtensionPointEnabled";function h(o){var f=o.getId();return E.getExtensionPointInfoByParentId({parentId:f}).length>0;}function i(){return sap.ui.getCore().getConfiguration().getDesignMode();}A.prototype.bAppDescriptorCommandAlreadyAvailable=false;A.prototype._isEditable=function(o){if(i()){var f=o.getElement();return this.hasChangeHandler(a,f).then(function(H){return H&&h(f)&&this.hasStableId(o);}.bind(this));}return Promise.resolve(false);};A.prototype.isEnabled=function(f){return f.length===1;};function c(o,m,C){var s=m.extensionPointName;var v=F.getViewForControl(o);var f={name:s,view:v};var g={fragment:m.fragment,fragmentPath:m.fragmentPath};return this.getCommandFactory().getCommandFor(f,a,g).then(function(j){return C.addCommand(j);});}function d(o,C){var f=M.isFlexExtensionPointHandlingEnabled(o);if(f||this.bAppDescriptorCommandAlreadyAvailable){return Promise.resolve();}var g=F.getAppComponentForControl(o);var r=g.getManifestEntry("sap.app").id;return this.getCommandFactory().getCommandFor(o,"appDescriptor",{reference:r,appComponent:g,changeType:b,parameters:{flexExtensionPointEnabled:true},texts:{}}).then(function(j){this.bAppDescriptorCommandAlreadyAvailable=true;return C.addCommand(j);}.bind(this));}function e(f,m){var C;var o=f[0];var g=o.getElement();return this.getCommandFactory().getCommandFor(g,"composite").then(function(_){C=_;}).then(function(){return c.call(this,g,m,C);}.bind(this)).then(function(){return d.call(this,g,C);}.bind(this)).then(function(){return C;});}A.prototype.handler=function(f,p){return Promise.resolve().then(function(){var g=p.fragmentHandler||this.getFragmentHandler();if(!g){return Promise.reject("Fragment handler function is not available in the handler");}var o=f[0];var j=o.getElement().getId();var k=E.getExtensionPointInfoByParentId({parentId:j});return g(o,k);}.bind(this)).then(function(m){if(!m.extensionPointName||!(typeof m.extensionPointName==="string")){return Promise.reject("Extension point name is not selected!");}if(!m.fragmentPath||!(typeof m.fragmentPath==="string")){return Promise.reject("Fragment path is not available");}return m;}).then(function(m){return e.call(this,f,m);}.bind(this)).then(function(C){this.fireElementModified({command:C});}.bind(this)).catch(function(v){throw D.propagateError(v,"AddXMLAtExtensionPoint#handler","Error occured in AddXMLAtExtensionPoint handler function","sap.ui.rta");});};A.prototype.getMenuItems=function(f){return this._getMenuItems(f,{pluginId:"CTX_ADDXML_AT_EXTENSIONPOINT",rank:110,icon:"sap-icon://add-equipment"});};A.prototype.getActionName=function(){return"AddXMLAtExtensionPoint";};A.prototype.getAction=function(){return{changeType:a};};return A;});
