/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_Helper","sap/ui/model/Filter"],function(_,F){"use strict";var a={"grandTotal":"boolean","max":"boolean","min":"boolean","name":"string","subtotals":"boolean","with":"string"},A={aggregate:"object",group:"object",groupLevels:"array"},b;function c(D,m,n){var k;function e(M){if(n){M+=" at property: "+n;}throw new Error(M);}function t(v){return Array.isArray(v)?"array":typeof v;}for(k in D){if(!(m&&k in m)){e("Unsupported '"+k+"'");}else if(t(D[k])!==m[k]){e("Not a "+m[k]+" value for '"+k+"'");}}}function d(m,e){var n;for(n in m){c(m[n],e,n);}}b={buildApply:function(o,q,m,f){var e,s="",C=[],g,h,S;function i(k){var D=o.aggregate[k],l=D.name||k,G=k,w=D.with;if(w){if((w==="average"||w==="countdistinct")&&(D.grandTotal||D.subtotals)){throw new Error("Cannot aggregate totals with '"+w+"'");}l+=" with "+w+" as "+k;}else if(D.name){l+=" as "+k;}if(!f){if(D.min){p(k,"min");}if(D.max){p(k,"max");}}if(D.grandTotal){h=true;if(!q.$skip){if(w){G+=" with "+w+" as UI5grand__"+k;}C.push(G);}}return l;}function n(G){return o.groupLevels.indexOf(G)<0;}function p(N,M){var k="UI5"+M+"__"+N;C.push(N+" with "+M+" as "+k);if(m){m[k]={measure:N,method:M};}}function j(){var t="";if(q.$skip){t="skip("+q.$skip+")";}delete q.$skip;if(q.$top<Infinity){if(t){t+="/";}t+="top("+q.$top+")";}delete q.$top;return t;}q=Object.assign({},q);c(o,A);o.groupLevels=o.groupLevels||[];o.aggregate=o.aggregate||{};d(o.aggregate,a);e=Object.keys(o.aggregate).sort().map(i);if(h&&o.groupLevels.length){throw new Error("Cannot combine visual grouping with grand total");}if(e.length){s="aggregate("+e.join(",")+")";}o.group=o.group||{};d(o.group);g=o.groupLevels.concat(Object.keys(o.group).sort().filter(n));if(g.length){s="groupby(("+g.join(",")+(s?"),"+s+")":"))");}if(f){delete q.$count;}else if(q.$count){C.push("$count as UI5__count");delete q.$count;}if(q.$$filterBeforeAggregate){s="filter("+q.$$filterBeforeAggregate+")/"+s;delete q.$$filterBeforeAggregate;}if(q.$filter){s+="/filter("+q.$filter+")";delete q.$filter;}if(q.$orderby){s+="/orderby("+q.$orderby+")";delete q.$orderby;}if(h){if(q.$skip){q.$skip-=1;}else{q.$top-=1;}}S=j();if(C.length){s+="/concat(aggregate("+C.join(",")+"),"+(S||"identity")+")";}else if(S){s+="/"+S;}if(s){q.$apply=s;}return q;},hasGrandTotal:function(m){return!!m&&Object.keys(m).some(function(s){return m[s].grandTotal;});},hasMinOrMax:function(m){return!!m&&Object.keys(m).some(function(s){var D=m[s];return D.min||D.max;});},isAffected:function(o,f,s){function e(S,p){if(S.endsWith("/*")){S=S.slice(0,-2);}return _.hasPathPrefix(p,S)||_.hasPathPrefix(S,p);}function h(S,g){return g.some(function(i){return i.aFilters?h(S,i.aFilters):e(S,i.sPath);});}return s.some(function(S){var g=e.bind(null,S);return S===""||S==="*"||Object.keys(o.aggregate).some(function(i){var D=o.aggregate[i];return e(S,D.name||i);})||Object.keys(o.group).some(g)||o.groupLevels.some(g)||h(S,f);});},splitFilter:function(f,o){var e=[],g=[];function i(f){return f.aFilters?f.aFilters.some(i):f.sPath in o.aggregate;}function s(f){if(f.aFilters&&f.bAnd){f.aFilters.forEach(s);}else{(i(f)?e:g).push(f);}}function w(h){return h.length>1?new F(h,true):h[0];}if(!o||!o.aggregate){return[f];}s(f);return[w(e),w(g)];}};return b;},false);
