/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,i,J,C,c,L,R,U,d,f,F,M){"use strict";var g={};var h="unclassified";var N={lastOneWins:L,reverse:R};function j(S,a){return a.classification===sap.ui.fl.condenser.Classification.Create&&S[sap.ui.fl.condenser.Classification.Move];}function k(S,a){return a.classification===sap.ui.fl.condenser.Classification.Move&&S[sap.ui.fl.condenser.Classification.Destroy];}function l(a,b){return b.classification===sap.ui.fl.condenser.Classification.Create&&a[sap.ui.fl.condenser.Classification.Destroy];}function m(a,b,A,B){if(!k(a,A)&&!l(a,A)){var D=A.classification;if(!a[D]){A.change=B;a[D]=[A];}}if(j(a,A)||l(a,A)){delete a[sap.ui.fl.condenser.Classification.Move];delete a[sap.ui.fl.condenser.Classification.Destroy];}U.addChange(b,A);}function n(T,a,I,b,A){if(!T[b.type]){T[b.type]={};}var B=T[b.type];if(b.type===d.NOT_INDEX_RELEVANT){if(!B[b.classification]){B[b.classification]={};}var P=B[b.classification];N[b.classification].addToChangesMap(P,b.uniqueKey,A);}else{I.push(A);m(B,a,b,A);}}function o(T,K,a){if(!T[K]){T[K]=[];}T[K].push(a);}function p(a,b){var A=J.getControlIdBySelector(b.getSelector(),a);var B=C.byId(A);if(B){var P={modifier:J,appComponent:a,view:F.getViewForControl(B)};var D=c.getControlIfTemplateAffected(b,B,P);return Promise.resolve(c.getChangeHandler(b,D,P)).then(function(E){if(E&&typeof E.getCondenserInfo==="function"){return E.getCondenserInfo(b);}});}return Promise.resolve();}function q(a,b,A,B){var D=b!==undefined?b.affectedControl:J.getControlIdBySelector(A.getSelector(),B);if(!a[D]){a[D]={};}return a[D];}function r(a,b,A,I,B){return B.reduce(function(P,D){return P.then(s.bind(this,a,b,A,I,D));}.bind(this),Promise.resolve());}function s(a,b,A,I,B){return p(a,B).then(function(D){u(D,a);var T=q(b,D,B,a);if(D!==undefined){t(D);n(T,A,I,D,B);}else{o(T,h,B);b[h]=true;}});}function t(a){if(N[a.classification]){a.type=d.NOT_INDEX_RELEVANT;}else{a.type=d.INDEX_RELEVANT;}}function u(a,A){["affectedControl","sourceContainer","targetContainer"].forEach(function(P){if(a&&a[P]){a[P]=J.getControlIdBySelector(a[P],A);}});}function v(O,a){e(O,function(K,S){if(N[K]&&N[K].getChangesFromMap){N[K].getChangesFromMap(O,K).forEach(function(b){a.push(b);});}else if(i(S)){return v(S,a);}else if(Array.isArray(S)){S.forEach(function(b){if(b instanceof f){a.push(b);}else{a.push(b.change);}});}});return a;}function w(a){return v(a,[]);}function x(a,b){e(a,function(K,S){if(i(S)){x(S,b);}else if(Array.isArray(S)){S.forEach(function(O){if(!(O instanceof f)){b.push(O);}});}});return b;}function y(A,B){B.sort(function(a,b){return A.indexOf(a)-A.indexOf(b);});}function z(a,I){var b=a.map(function(A){return A.getId();});I.forEach(function(A){if(b.indexOf(A.getId())===-1){a.push(A);}});}g.condense=function(a,b){M.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var A={};var B={};var D=[];var E=[];var G=[];b.slice(0).reverse().forEach(function(H){if(H instanceof f&&H.isApplyProcessFinished()){G.push(H);}else{E.push(H);}});M.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return r(a,A,B,D,G).then(function(){M.end("Condenser_defineMaps");var H=A[h];if(!H){U.compareAndUpdate(A,B);}var I=w(A);if(H){z(I,D);}I=I.concat(E);y(b,I);if(!H){M.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var K=x(A,[]);M.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var O=U.sortIndexRelatedChanges(B,K);M.end("Condenser_sort");U.swapChanges(O,I);M.end("Condenser_handleIndexRelatedChanges");}M.end("Condenser_overall");return I;});};return g;});
